<!DOCTYPE html>
<html>
<head>
    <title>Bus Assignments - Admin</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        h1 { color: #4CAF50; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
        h2 { color: #2196F3; border-bottom: 2px solid #2196F3; padding-bottom: 10px; margin-top: 30px; }
        .nav-links { margin: 20px 0; }
        .nav-links a { margin-right: 15px; padding: 8px 15px; background: #4CAF50; color: white; text-decoration: none; border-radius: 4px; }
        .nav-links a:hover { background: #45a049; }
        .count { background: #4CAF50; color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; }
        .badge-active { background-color: #4CAF50; }
        .badge-inactive { background-color: #f44336; }
        .badge-assigned { background-color: #2196F3; }
        .badge-unassigned { background-color: #ff9800; }
        .btn-view { padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-view:hover { background: #1976D2; }
        .btn-back { padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px; }
        .btn-back:hover { background: #d32f2f; }
        #busChildren { display: none; }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: #e3f2fd !important; }

        /* Tab Styles */
        .tab-container { margin: 20px 0; border-bottom: 2px solid #ddd; }
        .tabs { display: flex; gap: 0; }
        .tab {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab:hover { background: #e0e0e0; }
        .tab.active {
            background: white;
            color: #4CAF50;
            border-bottom: 3px solid #4CAF50;
        }
        .tab-content { display: none; padding: 20px 0; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöå Bus Assignments Management</h1>
        <div class="nav-links">
            <a href="dashboard.html">‚Üê Back to Dashboard</a>
            <a href="view_drivers.html">View Drivers</a>
            <a href="view_busminders.html">View Bus Minders</a>
            <a href="view_parents.html">View Parents</a>
            <a href="view_children.html">View Children</a>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('buses')">üöå Buses</button>
                <button class="tab" onclick="switchTab('children')">üë∂ Children Assignments</button>
                <button class="tab" onclick="switchTab('busminders')">üë®‚Äç‚úàÔ∏è Bus Minders Assignments</button>
            </div>
        </div>

        <!-- Buses Tab -->
        <div id="buses-tab" class="tab-content active">
            <p>Total Buses: <span class="count" id="busCount">0</span></p>

            <table id="busesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Number Plate</th>
                        <th>Driver</th>
                        <th>Bus Minder</th>
                        <th>Status</th>
                        <th>Current Location</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Children Assignments Tab -->
        <div id="children-tab" class="tab-content">
            <p>Total Children with Bus Assignment: <span class="count" id="childrenCount">0</span></p>

            <table id="childrenTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Grade</th>
                        <th>Assigned Bus</th>
                        <th>Parent Name</th>
                        <th>Parent Phone</th>
                        <th>Assignment Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Bus Minders Assignments Tab -->
        <div id="busminders-tab" class="tab-content">
            <p>Total Bus Minders: <span class="count" id="busmindersCount">0</span></p>

            <table id="busmindersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Assigned Bus</th>
                        <th>Assignment Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Modal for viewing bus children (from Buses tab) -->
        <div id="busChildren" style="display: none;">
            <button class="btn-back" onclick="hideBusChildren()">‚Üê Back to Buses</button>
            <h2>üë∂ Children Assigned to <span id="selectedBusName"></span></h2>

            <table id="busChildrenTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Grade</th>
                        <th>Parent</th>
                        <th>Parent Phone</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';

        window.onload = async function() {
            await loadBuses();
            await loadChildren();
            await loadBusminders();
        };

        // Tab Switching Function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        async function loadBuses() {
            try {
                const res = await fetch(`${API_BASE}/buses/`);
                const buses = await res.json();

                document.getElementById('busCount').textContent = buses.length;

                const tbody = document.querySelector('#busesTable tbody');
                tbody.innerHTML = '';

                buses.forEach(bus => {
                    const statusClass = bus.is_active ? 'badge-active' : 'badge-inactive';
                    const statusText = bus.is_active ? 'Active' : 'Inactive';
                    tbody.innerHTML += `
                        <tr class="clickable-row">
                            <td>${bus.id}</td>
                            <td>${bus.number_plate}</td>
                            <td>${bus.driver_name || 'Unassigned'}</td>
                            <td>${bus.bus_minder_name || 'Unassigned'}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>${bus.current_location || 'N/A'}</td>
                            <td>
                                <button class="btn-view" onclick="viewBusChildren(${bus.id}, '${bus.number_plate}')">
                                    üë∂ View Children
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } catch(e) {
                console.error('Error loading buses:', e);
                alert('Error loading buses');
            }
        }

        async function loadChildren() {
            try {
                const res = await fetch(`${API_BASE}/children/`);
                const children = await res.json();

                document.getElementById('childrenCount').textContent = children.length;

                const tbody = document.querySelector('#childrenTable tbody');
                tbody.innerHTML = '';

                if (children.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No children found</td></tr>';
                } else {
                    children.forEach(child => {
                        const assignmentStatus = child.bus_id ? 'badge-assigned' : 'badge-unassigned';
                        const assignmentText = child.bus_id ? 'Assigned' : 'Unassigned';
                        const busInfo = child.bus_number_plate ? `Bus ${child.bus_number_plate}` : 'Not Assigned';

                        tbody.innerHTML += `
                            <tr>
                                <td>${child.id}</td>
                                <td>${child.first_name} ${child.last_name}</td>
                                <td>${child.class_grade || 'N/A'}</td>
                                <td>${busInfo}</td>
                                <td>${child.parent_name || 'N/A'}</td>
                                <td>${child.parent_phone || 'N/A'}</td>
                                <td><span class="badge ${assignmentStatus}">${assignmentText}</span></td>
                            </tr>
                        `;
                    });
                }
            } catch(e) {
                console.error('Error loading children:', e);
                alert('Error loading children assignments');
            }
        }

        async function loadBusminders() {
            try {
                const res = await fetch(`${API_BASE}/busminders/`);
                const busminders = await res.json();

                document.getElementById('busmindersCount').textContent = busminders.length;

                const tbody = document.querySelector('#busmindersTable tbody');
                tbody.innerHTML = '';

                if (busminders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No bus minders found</td></tr>';
                } else {
                    busminders.forEach(busminder => {
                        const assignmentStatus = busminder.bus_id ? 'badge-assigned' : 'badge-unassigned';
                        const assignmentText = busminder.bus_id ? 'Assigned' : 'Unassigned';
                        const busInfo = busminder.bus_number_plate ? `Bus ${busminder.bus_number_plate}` : 'Not Assigned';

                        tbody.innerHTML += `
                            <tr>
                                <td>${busminder.id}</td>
                                <td>${busminder.first_name} ${busminder.last_name}</td>
                                <td>${busminder.email || 'N/A'}</td>
                                <td>${busminder.phone || 'N/A'}</td>
                                <td>${busInfo}</td>
                                <td><span class="badge ${assignmentStatus}">${assignmentText}</span></td>
                                <td>
                                    <button class="btn-view" onclick="viewBusminderDetails(${busminder.id})">
                                        üìã View Details
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
            } catch(e) {
                console.error('Error loading bus minders:', e);
                alert('Error loading bus minders assignments');
            }
        }

        async function viewBusChildren(busId, busNumberPlate) {
            try {
                const res = await fetch(`${API_BASE}/children/?bus=${busId}`);
                const children = await res.json();

                document.getElementById('selectedBusName').textContent = `Bus ${busNumberPlate}`;
                const tbody = document.querySelector('#busChildrenTable tbody');
                tbody.innerHTML = '';

                if (children.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">No children assigned to this bus</td></tr>';
                } else {
                    children.forEach(child => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${child.id}</td>
                                <td>${child.first_name} ${child.last_name}</td>
                                <td>${child.class_grade}</td>
                                <td>${child.parent_name || 'N/A'}</td>
                                <td>${child.parent_phone || 'N/A'}</td>
                            </tr>
                        `;
                    });
                }

                // Hide all tabs and show bus children modal
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.style.display = 'none';
                });
                document.getElementById('busChildren').style.display = 'block';
            } catch(e) {
                console.error('Error loading bus children:', e);
                alert('Error loading children for this bus');
            }
        }

        function hideBusChildren() {
            document.getElementById('busChildren').style.display = 'none';
            // Show buses tab again
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.getElementById('buses-tab').style.display = 'block';
            document.getElementById('buses-tab').classList.add('active');
        }

        function viewBusminderDetails(busminderId) {
            alert(`Viewing details for Bus Minder ID: ${busminderId}`);
            // You can implement a detailed view modal here similar to viewBusChildren
        }
    </script>
</body>
</html>
