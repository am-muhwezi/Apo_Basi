<!DOCTYPE html>
<html>
<head>
    <title>Manage Assignments</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        h2 { color: #333; }
        select, button { padding: 8px; margin: 5px; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Manage Assignments</h1>
    <a href="dashboard.html">‚Üê Back to Dashboard</a>

    <div class="section">
        <h2>Assign Driver to Bus</h2>
        <select id="driverSelect"></select>
        <select id="busForDriver"></select>
        <button onclick="assignDriverToBus()">Assign Driver</button>
        <div id="driverResult"></div>
    </div>

    <div class="section">
        <h2>Assign Bus Minder to Bus</h2>
        <select id="busminderSelect"></select>
        <select id="busForBusminder"></select>
        <button onclick="assignBusminderToBus()">Assign Bus Minder</button>
        <div id="busminderResult"></div>
    </div>

    <div class="section">
        <h2>Assign Child to Bus</h2>
        <select id="childSelect"></select>
        <select id="busForChild"></select>
        <button onclick="assignChildToBus()">Assign Child</button>
        <div id="childResult"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';

        // Load all data on page load
        window.onload = async function() {
            await loadDrivers();
            await loadBusminders();
            await loadChildren();
            await loadBuses();
        };

        async function loadDrivers() {
            try {
                const res = await fetch(`${API_BASE}/users/`, {
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await res.json();
                const drivers = data.filter(u => u.user_type === 'driver');
                const select = document.getElementById('driverSelect');
                select.innerHTML = '<option value="">Select Driver</option>';
                drivers.forEach(d => {
                    select.innerHTML += `<option value="${d.id}">${d.first_name} ${d.last_name} (${d.username})</option>`;
                });
            } catch(e) {
                console.error('Error loading drivers:', e);
            }
        }

        async function loadBusminders() {
            try {
                const res = await fetch(`${API_BASE}/users/`, {
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await res.json();
                const busminders = data.filter(u => u.user_type === 'busminder');
                const select = document.getElementById('busminderSelect');
                select.innerHTML = '<option value="">Select Bus Minder</option>';
                busminders.forEach(b => {
                    select.innerHTML += `<option value="${b.id}">${b.first_name} ${b.last_name} (${b.username})</option>`;
                });
            } catch(e) {
                console.error('Error loading busminders:', e);
            }
        }

        async function loadChildren() {
            try {
                const res = await fetch(`${API_BASE}/children/`, {
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await res.json();
                const select = document.getElementById('childSelect');
                select.innerHTML = '<option value="">Select Child</option>';
                data.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${c.first_name} ${c.last_name} - Grade ${c.class_grade}</option>`;
                });
            } catch(e) {
                console.error('Error loading children:', e);
            }
        }

        async function loadBuses() {
            try {
                const res = await fetch(`${API_BASE}/buses/`, {
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await res.json();

                // Populate all bus selects
                ['busForDriver', 'busForBusminder', 'busForChild'].forEach(id => {
                    const select = document.getElementById(id);
                    select.innerHTML = '<option value="">Select Bus</option>';
                    data.forEach(bus => {
                        select.innerHTML += `<option value="${bus.id}">Bus ${bus.number_plate}</option>`;
                    });
                });
            } catch(e) {
                console.error('Error loading buses:', e);
            }
        }

        async function assignDriverToBus() {
            const driverId = document.getElementById('driverSelect').value;
            const busId = document.getElementById('busForDriver').value;
            const resultDiv = document.getElementById('driverResult');

            if (!driverId || !busId) {
                resultDiv.innerHTML = '<p class="error">Please select both driver and bus</p>';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admins/assign-driver-to-bus/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ driver_id: parseInt(driverId), bus_id: parseInt(busId) })
                });
                const data = await res.json();
                if (res.ok) {
                    resultDiv.innerHTML = `<p class="success">${data.message}</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="error">${data.error || 'Assignment failed'}</p>`;
                }
            } catch(e) {
                resultDiv.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }
        }

        async function assignBusminderToBus() {
            const busminderId = document.getElementById('busminderSelect').value;
            const busId = document.getElementById('busForBusminder').value;
            const resultDiv = document.getElementById('busminderResult');

            if (!busminderId || !busId) {
                resultDiv.innerHTML = '<p class="error">Please select both bus minder and bus</p>';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admins/assign-busminder-to-bus/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ busminder_id: parseInt(busminderId), bus_id: parseInt(busId) })
                });
                const data = await res.json();
                if (res.ok) {
                    resultDiv.innerHTML = `<p class="success">${data.message}</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="error">${data.error || 'Assignment failed'}</p>`;
                }
            } catch(e) {
                resultDiv.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }
        }

        async function assignChildToBus() {
            const childId = document.getElementById('childSelect').value;
            const busId = document.getElementById('busForChild').value;
            const resultDiv = document.getElementById('childResult');

            if (!childId || !busId) {
                resultDiv.innerHTML = '<p class="error">Please select both child and bus</p>';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/admins/assign-child-to-bus/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ child_id: parseInt(childId), bus_id: parseInt(busId) })
                });
                const data = await res.json();
                if (res.ok) {
                    resultDiv.innerHTML = `<p class="success">${data.message}</p>`;
                } else {
                    resultDiv.innerHTML = `<p class="error">${data.error || 'Assignment failed'}</p>`;
                }
            } catch(e) {
                resultDiv.innerHTML = `<p class="error">Error: ${e.message}</p>`;
            }
        }
    </script>
</body>
</html>
