<!DOCTYPE html>
<html>
<head>
    <title>My Children</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        h1 { color: #333; }
        .child-card { background: white; padding: 20px; margin: 15px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .child-card h3 { color: #2196F3; margin-top: 0; }
        .info-row { display: flex; justify-content: space-between; margin: 10px 0; padding: 8px; background: #f9f9f9; border-radius: 4px; }
        .info-label { font-weight: bold; color: #555; }
        .info-value { color: #333; }
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: bold; }
        .status-present { background-color: #4CAF50; color: white; }
        .status-absent { background-color: #f44336; color: white; }
        .status-unknown { background-color: #9E9E9E; color: white; }
        .bus-info { background: #E3F2FD; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .bus-info h4 { margin-top: 0; color: #1976D2; }
        .no-children { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>
    <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ My Children</h1>
    <p>Login to view your children. For testing, use credentials from parent creation.</p>

    <div>
        <label>Username: <input type="text" id="username" placeholder="parent_xxxxx"></label>
        <label>Password: <input type="password" id="password" placeholder="password"></label>
        <button onclick="login()">Login</button>
        <button onclick="logout()">Logout</button>
    </div>

    <div id="childrenContainer"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let authToken = localStorage.getItem('parent_token');

        window.onload = function() {
            if (authToken) {
                loadChildren();
            }
        };

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_BASE}/users/login/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (res.ok && data.access) {
                    authToken = data.access;
                    localStorage.setItem('parent_token', authToken);
                    alert('Login successful!');
                    loadChildren();
                } else {
                    alert('Login failed: ' + (data.detail || 'Invalid credentials'));
                }
            } catch(e) {
                alert('Error: ' + e.message);
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('parent_token');
            document.getElementById('childrenContainer').innerHTML = '';
            alert('Logged out');
        }

        async function loadChildren() {
            if (!authToken) {
                document.getElementById('childrenContainer').innerHTML = '<div class="no-children">Please login to view your children</div>';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/parents/children/`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!res.ok) {
                    throw new Error('Failed to load children');
                }

                const children = await res.json();
                const container = document.getElementById('childrenContainer');

                if (children.length === 0) {
                    container.innerHTML = '<div class="no-children">No children found</div>';
                    return;
                }

                container.innerHTML = '';
                children.forEach(child => {
                    const statusClass = child.attendance_status === 'present' ? 'status-present' :
                                       child.attendance_status === 'absent' ? 'status-absent' : 'status-unknown';
                    const statusText = child.attendance_status || 'Not Marked';

                    container.innerHTML += `
                        <div class="child-card">
                            <h3>üë∂ ${child.first_name} ${child.last_name}</h3>

                            <div class="info-row">
                                <span class="info-label">Grade:</span>
                                <span class="info-value">${child.class_grade}</span>
                            </div>

                            <div class="info-row">
                                <span class="info-label">Attendance Today:</span>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>

                            ${child.assigned_bus ? `
                                <div class="bus-info">
                                    <h4>üöå Bus Information</h4>
                                    <div class="info-row">
                                        <span class="info-label">Bus Number:</span>
                                        <span class="info-value">${child.bus_number}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Driver:</span>
                                        <span class="info-value">${child.driver_name || 'Not Assigned'}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Bus Status:</span>
                                        <span class="info-value">${child.bus_active ? 'Active' : 'Inactive'}</span>
                                    </div>
                                </div>
                            ` : `
                                <div class="info-row">
                                    <span class="info-label">Bus:</span>
                                    <span class="info-value" style="color: #f44336;">Not Assigned</span>
                                </div>
                            `}
                        </div>
                    `;
                });
            } catch(e) {
                console.error('Error loading children:', e);
                document.getElementById('childrenContainer').innerHTML = `<div class="no-children">Error: ${e.message}</div>`;
            }
        }
    </script>
</body>
</html>
